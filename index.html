<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f7f9fb; color: #333; line-height: 1.6; }

    /* === –ö–í–ò–ó FLEXBE –°–¢–ò–õ–¨ === */
.quiz-wrapper * { all: unset; display: revert; box-sizing: border-box; }

.quiz-wrapper{
  min-height:100svh; display:flex; align-items:center; justify-content:center;
  padding:24px; background:linear-gradient(180deg,#f6f9fc 0%,#eef3f8 100%);
}
.quiz{
  width:min(880px,96vw); background:#fff; border-radius:20px;
  box-shadow:0 20px 60px rgba(10,61,98,.15); overflow:hidden;
  display:grid; grid-template-columns:1fr;
}
.quiz__header{
  background:#0a3d62; color:#fff; padding:18px 22px; display:flex; align-items:center; gap:12px;
}
.quiz__logo{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.15);display:grid;place-items:center;font-weight:700;}
.quiz__title{font-weight:800;}
.quiz__progress{margin-left:auto;display:flex;align-items:center;gap:10px;font-size:13px;opacity:.9;}
.bar{width:160px;height:8px;border-radius:999px;background:rgba(255,255,255,.25);overflow:hidden;}
.bar>span{display:block;height:100%;background:#fff;width:0%}
.quiz__body{padding:28px 28px 22px;}
.step{display:none;animation:fade .35s ease;}
.step.active{display:block;}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.q{font-size:22px;font-weight:800;color:#0a3d62;margin-bottom:16px;}
.options{display:grid;gap:12px;grid-template-columns:repeat(3,1fr);}
.btn-opt{border:1px solid #e7eef7;border-radius:14px;padding:16px 14px;background:#f8fbff;cursor:pointer;text-align:center;transition:.2s;font-weight:600;}
.btn-opt:hover{transform:translateY(-1px);background:#f0f6ff;}
.btn-opt.active{outline:2px solid #0a3d62;background:#e8f3ff;}
.controls{display:flex;gap:10px;justify-content:space-between;margin-top:22px;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 18px;border-radius:12px;border:1px solid #e7eef7;background:#fff;cursor:pointer;transition:.2s;font-weight:700;}
.btn--primary{background:#ff6b6b;color:#fff;border-color:transparent;}
.btn--primary:hover{filter:brightness(.98);transform:translateY(-1px);}
.muted{color:#6b7a90;font-size:13px;margin-top:6px;}
.lead{display:grid;gap:12px;grid-template-columns:1fr 1fr;}
.field{display:grid;gap:8px;}
.input{padding:14px 12px;border-radius:12px;border:1px solid #e7eef7;font-size:16px;background:#f9fbfd;}
.result{border:1px dashed #e7eef7;padding:14px;border-radius:12px;background:#fbfdff;margin-top:10px;font-size:14px;}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700;}
.ok{background:#e9f7f0;color:#18a957;}
.warn{background:#fff6e5;color:#996b00;}
.deny{background:#ffeaea;color:#d9534f;}
.footer{padding:14px 22px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-top:1px solid #e7eef7;background:#fcfdff;}
.hint{font-size:12px;color:#6b7a90}
.debug-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; margin-bottom: 16px; }
.debug-section { margin-bottom: 12px; }
.debug-title { font-weight: 600; margin-bottom: 6px; color: #0a3d62; }
.debug-line { margin-bottom: 4px; }
.debug-status { margin-top: 12px; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 14px; }

@media(max-width:680px){
  .options{grid-template-columns:1fr}
  .lead{grid-template-columns:1fr}
  .quiz__header{flex-wrap:wrap;gap:8px}
  .quiz__progress{width:100%}
  .bar{flex:1}
  .debug-grid { grid-template-columns: 1fr; }
}
    /* Chat block */
    .chat-container {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      height: 500px;
      overflow: hidden;
      border: 1px solid #e8e8e8;
    }
    .chat-header {
      background: #0a3d62;
      color: white;
      padding: 15px 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .chat-header img {
      width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex: 0 0 40px;
    }
    .chat-header .title { font-size: 16px; font-weight: 700; }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: #f8fafc;
    }
    .message {
      max-width: 80%;
      padding: 12px 18px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.5;
    }
    .bot {
      background: #eef4f9;
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }
    .user {
      background: #ff6b6b;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }
    .chat-suggestions {
      padding: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      border-top: 1px solid #e8e8e8;
      background: #f5f7fa;
    }
    .chat-suggestions button {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background: #eef4f9;
      cursor: pointer;
      font-size: 13px;
      transition: 0.3s;
      color: #0a3d62;
    }
    .chat-suggestions button:hover {
      background: #d6e4f0;
    }
    .chat-input {
      display: flex;
      border-top: 1px solid #e8e8e8;
    }
    .chat-input input {
      flex: 1;
      padding: 16px;
      border: none;
      outline: none;
      font-size: 15px;
    }
    .chat-input button {
      padding: 0 20px;
      border: none;
      background: #ff6b6b;
      color: white;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.3s;
    }
    .chat-input button:hover { background: #ff4b4b; }
    .chat-input button svg { width: 20px; height: 20px; fill: white; }

    #typingIndicator {
      font-style: italic;
      display: none;
      align-self: flex-start;
      margin-left: 10px;
    }
    #typingIndicator .dot {
      animation: blink 1.2s infinite ease-in-out;
      opacity: 0.3;
    }
    #typingIndicator .dot:nth-child(2){animation-delay:0.2s;}
    #typingIndicator .dot:nth-child(3){animation-delay:0.4s;}
    @keyframes blink {
      0%,80%,100%{opacity:0.3;}
      40%{opacity:1;}
    }

    /* Popup form */
    #leadOverlay {
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,0.6); z-index:9998;
    }
    #leadPopup, #leadThanks {
      display:none; position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#fff; color:#333; padding:30px;
      border-radius:16px; z-index:9999;
      max-width:400px; width:90%;
      box-shadow:0 0 30px rgba(0,0,0,0.4);
      text-align:center;
    }
    #leadPopup h3 { margin-bottom:20px; color:#0a3d62; font-size:22px; }
    #leadPopup input {
      width:100%; padding:12px; border-radius:8px;
      border:1px solid #ccc; margin-bottom:15px;
      font-size:16px;
    }
    #leadPopup button {
      width:100%; padding:14px;
      border:none; border-radius:8px;
      background-color:#ff6b6b; color:#fff;
      font-weight:bold; cursor:pointer; font-size:16px;
    }
    #leadPopup button:hover { background:#ff4b4b; }
  </style>
</head>
<body>
  <!-- –¢–û–õ–¨–ö–û –ö–í–ò–ó -->
  <div class="quiz-wrapper">
    <div class="quiz" id="quiz">
      <div class="quiz__header">
        <div class="quiz__logo">AU</div>
        <div class="quiz__title">–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ</div>
        <div class="quiz__progress">
          <span id="pText">1 / 6</span>
          <div class="bar"><span id="pBar"></span></div>
        </div>
      </div>
      <div class="quiz__body">
        <div class="step active" data-step="1">
          <div class="q">1. –ö–∞–∫–∞—è —É –≤–∞—Å —Å—É–º–º–∞ –¥–æ–ª–≥–∞?</div>
          <div class="options">
            <button class="btn-opt" data-name="debt" data-value="–¥–æ 300 —Ç—ã—Å.">–î–æ 300 —Ç—ã—Å.</button>
            <button class="btn-opt" data-name="debt" data-value="300‚Äì500 —Ç—ã—Å.">300‚Äì500 —Ç—ã—Å.</button>
            <button class="btn-opt" data-name="debt" data-value="–±–æ–ª–µ–µ 500 —Ç—ã—Å.">–ë–æ–ª–µ–µ 500 —Ç—ã—Å.</button>
          </div>
        </div>

        <div class="step" data-step="2">
          <div class="q">2. –ï—Å—Ç—å –ª–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∏?</div>
          <div class="options">
            <button class="btn-opt" data-name="delay" data-value="–Ω–µ—Ç">–ù–µ—Ç</button>
            <button class="btn-opt" data-name="delay" data-value="–º–µ–Ω–µ–µ 3 –º–µ—Å.">–ú–µ–Ω–µ–µ 3 –º–µ—Å.</button>
            <button class="btn-opt" data-name="delay" data-value="–±–æ–ª–µ–µ 3 –º–µ—Å.">–ë–æ–ª–µ–µ 3 –º–µ—Å.</button>
          </div>
        </div>

        <div class="step" data-step="3">
          <div class="q">3. –†–∞–±–æ—Ç–∞–µ—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ?</div>
          <div class="options">
            <button class="btn-opt" data-name="job" data-value="–¥–∞">–î–∞</button>
            <button class="btn-opt" data-name="job" data-value="–Ω–µ—Ç">–ù–µ—Ç</button>
          </div>
        </div>

        <div class="step" data-step="4">
          <div class="q">4. –ï—Å—Ç—å –ª–∏ –∏–º—É—â–µ—Å—Ç–≤–æ –∫—Ä–æ–º–µ –∂–∏–ª—å—è?</div>
          <div class="options">
            <button class="btn-opt" data-name="property" data-value="–Ω–µ—Ç">–ù–µ—Ç</button>
            <button class="btn-opt" data-name="property" data-value="–µ—Å—Ç—å, —Ö–æ—á—É —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å">–ï—Å—Ç—å, —Ö–æ—á—É —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn-opt" data-name="property" data-value="–≥–æ—Ç–æ–≤ –ø—Ä–æ–¥–∞—Ç—å">–ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–∞—Ç—å</button>
          </div>
        </div>

        <div class="step" data-step="5">
          <div class="q">5. –û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</div>
          <div class="lead" id="leadForm">
            <div class="field">
              <label>–í–∞—à–µ –∏–º—è</label>
              <input id="quizName" class="input" placeholder="–ò–≤–∞–Ω">
            </div>
            <div class="field">
              <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
              <input id="quizPhone" class="input" placeholder="+7 900 000-00-00">
            </div>
            <!-- HONEYPOT –ü–û–õ–ï (—Å–∫—Ä—ã—Ç–æ–µ) -->
            <input type="text" id="quizHoneypot" style="display: none !important; opacity: 0; position: absolute; left: -9999px;" tabindex="-1" autocomplete="off">
          </div>
          <div class="result" id="summaryBox" style="display:none;"></div>
        </div>

        <!-- –ù–û–í–´–ô –®–ê–ì 6 - –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–¢–ò–ë–û–¢–ê -->
        <div class="step" data-step="6">
          <div class="q">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
          
          <div class="result" style="display:block; background:#f8fafc; border:1px solid #e2e8f0;">
            <div style="margin-bottom:16px; font-weight:600; color:#0a3d62;">ü§ñ –î–ê–ù–ù–´–ï –ê–ù–¢–ò–ë–û–¢-–ê–ù–ê–õ–ò–ó–ê</div>
            
            <div class="debug-grid">
              <!-- –¢–∞–π–º–∏–Ω–≥–∏ -->
              <div class="debug-section">
                <div class="debug-title">‚è± –¢–∞–π–º–∏–Ω–≥–∏</div>
                <div class="debug-line" id="debugDuration">‚Ä¢ –û–±—â–µ–µ –≤—Ä–µ–º—è: 0 —Å–µ–∫</div>
                <div class="debug-line" id="debugAvgInterval">‚Ä¢ –°—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: 0 –º—Å</div>
                <div class="debug-line" id="debugFastClicks">‚Ä¢ –ë—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–∫–∏: 0</div>
              </div>
              
              <!-- –°–æ–±—ã—Ç–∏—è -->
              <div class="debug-section">
                <div class="debug-title">üéØ –°–æ–±—ã—Ç–∏—è</div>
                <div class="debug-line" id="debugClicks">‚Ä¢ –ö–ª–∏–∫–∏: 0</div>
                <div class="debug-line" id="debugPaste">‚Ä¢ –í—Å—Ç–∞–≤–∫–∞ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω: –ù–ï–¢</div>
                <div class="debug-line" id="debugFakeClick">‚Ä¢ –ù–µ–≤–∏–¥–∏–º–∞—è –∫–Ω–æ–ø–∫–∞: –ù–ï–¢</div>
              </div>
              
              <!-- –û—Ü–µ–Ω–∫–∞ -->
              <div class="debug-section">
                <div class="debug-title">üìä –û—Ü–µ–Ω–∫–∞</div>
                <div class="debug-line" id="debugHeuristic">‚Ä¢ –≠–≤—Ä–∏—Å—Ç–∏–∫–∏: 0/100</div>
                <div class="debug-line" id="debugAI">‚Ä¢ AI-–∞–Ω–∞–ª–∏–∑: 0/100</div>
                <div class="debug-line" id="debugVerdict">‚Ä¢ –í–µ—Ä–¥–∏–∫—Ç: ‚Äî</div>
              </div>
              
              <!-- –ü—Ä–∏—á–∏–Ω—ã -->
              <div class="debug-section">
                <div class="debug-title">üîç –ü—Ä–∏—á–∏–Ω—ã</div>
                <div class="debug-line" id="debugReasons">‚Ä¢ –ê–Ω–∞–ª–∏–∑...</div>
              </div>
            </div>
            
            <!-- –°—Ç–∞—Ç—É—Å -->
            <div id="debugStatus" class="debug-status">
              ‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ...
            </div>
          </div>

          <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
          <div class="controls" style="margin-top:20px; justify-content:center; gap:16px;">
            <button class="btn" onclick="restartQuiz()" style="background:#f1f5f9; color:#475569;">
              üîÑ –ó–∞–ø–æ–ª–Ω–∏—Ç—å –µ—â—ë —Ä–∞–∑
            </button>
            <button class="btn btn--primary" onclick="goToPricing()">
              üöÄ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ
            </button>
          </div>
          
          <div class="muted" style="text-align:center; margin-top:12px;">
            –≠—Ç–æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è. –ü–æ–ª—É—á–∏—Ç–µ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∞–Ω—Ç–∏–±–æ—Ç—É –¥–ª—è –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞
          </div>
        </div>

        <div class="controls">
          <button class="btn btn--ghost" id="prevBtn" disabled>‚Üê –ù–∞–∑–∞–¥</button>
          <button class="btn btn--primary" id="nextBtn">–î–∞–ª–µ–µ ‚Üí</button>
        </div>
        <div class="muted">–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ 5 –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–∞</div>
      </div>
      <div class="footer">
        <div class="hint">–ê–Ω—Ç–∏–±–æ—Ç –≤–∫–ª—é—á—ë–Ω ‚Ä¢ –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è</div>
        <div class="hint" id="status">–®–∞–≥ 1 –∏–∑ 6</div>
      </div>
    </div>
  </div>

  <!-- –¢–û–õ–¨–ö–û –î–ò–ê–õ–û–ì–û–í–û–ï –û–ö–ù–û -->
  <div class="chat-container">
    <div class="chat-header">
      <img src="https://i.imgur.com/VnE8ZUa.png" alt="–ê–Ω–Ω–∞">
      <div class="title">–Æ—Ä–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ê–Ω–Ω–∞</div>
    </div>
    <div class="chat-messages" id="chat"></div>
    <div id="typingIndicator" style="display:none; padding:10px 20px; font-size:14px; color:#0a3d62;">
      –ê–Ω–Ω–∞ –ø–µ—á–∞—Ç–∞–µ—Ç<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
    </div>
    <div class="chat-suggestions">
      <button onclick="quickSend('–•–æ—á—É —É–∑–Ω–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–∞')">–£–∑–Ω–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å</button>
      <button onclick="quickSend('–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã?')">–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>
      <button onclick="quickSend('–ú–æ–≥—É –ª–∏ —è —Å–ø–∏—Å–∞—Ç—å –¥–æ–ª–≥–∏?')">–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</button>
    </div>
    <div class="chat-input">
      <button onclick="startVoice()" title="–ì–æ–≤–æ—Ä–∏—Ç—å">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M192 256c0 17.7-14.3 32-32 32s-32-14.3-32-32V128c0-17.7 14.3-32 32-32s32 14.3 32 32V256zM160 320c35.3 0 64-28.7 64-64V128a64 64 0 1 0-128 0V256c0 35.3 28.7 64 64 64zm56 32H104c-13.3 0-24 10.7-24 24s10.7 24 24 24h24v56c0 13.3 10.7 24 24 24s24-10.7 24-24V400h24c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/></svg>
      </button>
      <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å...">
      <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <!-- Overlay + Form + Thanks -->
  <div id="leadOverlay"></div>

  <div id="leadPopup">
    <h3 id="leadTitle">–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</h3>
    <input id="leadName" placeholder="–í–∞—à–µ –∏–º—è">
    <input id="leadPhone" placeholder="+7 (___) ___-__-__">
    <button id="leadSubmitBtn">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</button>
  </div>

  <div id="leadThanks">
    <div style="font-size: 18px; padding: 20px;">‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞—è–≤–∫—É!<br>–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç</div>
  </div>

<script src="https://unpkg.com/imask"></script>
<script>
  // === –í–°–ï –°–ï–†–í–ò–°–ù–´–ï URL –û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô ===
  const OPENAI_PROXY_URL = "https://openai-gpt-proxy-d2py.onrender.com/gpt";
  const LEAD_URL = "https://openai-gpt-proxy-d2py.onrender.com/lead";
  const QUIZ_URL = "https://openai-gpt-proxy-d2py.onrender.com/quiz";

  // === –í–ï–°–¨ JAVASCRIPT –ö–û–î –û–°–¢–ê–ï–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô ===
  let messages = [];
  const chatBox = document.getElementById("chat");
  const chatInput = document.getElementById("chatInput");

  // userId / UTM
  let userId = localStorage.getItem("userId") || "user_" + Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId", userId);

  const urlParams = new URLSearchParams(window.location.search);
  const utm_source = urlParams.get("utm_source") || "";
  const utm_content = urlParams.get("utm_content") || "";

  function appendMessage(text, fromUser=false){
    const div = document.createElement("div");
    div.className = "message " + (fromUser ? "user" : "bot");
    div.textContent = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // === –ñ–∏–≤–æ–π –Ω–∞–±–æ—Ä –ê–Ω–Ω—ã ===
  async function typeMessage(text) {
    const typingIndicator = document.getElementById("typingIndicator");
    typingIndicator.style.display = "block";

    const delay = Math.min(2500, 500 + text.length * 25); 
    await new Promise(r => setTimeout(r, delay));

    typingIndicator.style.display = "none";
    appendMessage(text, false);
    messages.push({ role: "assistant", content: text });
  }

  // === –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —á–∞—Ç–∞ ===
  async function sendMessage() {
    const text = chatInput.value.trim();
    if (!text) return;

    appendMessage(text, true);
    messages.push({ role: "user", content: text });
    chatInput.value = "";

    const now = Date.now();
    window.lastUserMessageTime = window.lastUserMessageTime || now;
    const responseDelay = now - window.lastUserMessageTime;
    window.lastUserMessageTime = now;

    try {
      const res = await fetch(OPENAI_PROXY_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages, userId, mode: "bankruptcy" })
      });
      const data = await res.json();
      let reply = data.choices?.[0]?.message?.content || "–û—à–∏–±–∫–∞";

      // –ê–Ω—Ç–∏–±–æ—Ç: –µ—Å–ª–∏ –æ—Ç–≤–µ—á–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ, —Ñ–æ—Ä–º—É –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
      if (responseDelay < 1000) {
        reply = reply.replace(/\[openLeadForm\]/gi, "");
      }

      // –ª–æ–≤–∏–º [openLeadForm] –∏–ª–∏ triggerForm
      if (/\[openLeadForm\]/i.test(reply) || data.triggerForm) {
        const clean = reply.replace(/\[openLeadForm\]/gi, "").trim();
        document.getElementById("leadTitle").innerText = clean || "–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é";
        openLeadForm();
        reply = clean;
      }

      // –ê–Ω–Ω–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç" –∂–∏–≤–æ
      await typeMessage(reply);

      // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ [nextMessage] ===
      if (reply.includes("[nextMessage]")) {
        const parts = reply.split("[nextMessage]").map(t => t.trim()).filter(Boolean);
        if (parts.length > 1) {
          const first = parts[0];
          const second = parts[1];

          chatBox.lastChild.textContent = first;

          const thinkingDelay = 1500 + Math.random() * 1000;
          setTimeout(async () => {
            await typeMessage(second);
          }, thinkingDelay);
        }
      }

    } catch (e) {
      appendMessage("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", false);
    }
  }

  function quickSend(text){
    chatInput.value=text;
    sendMessage();
  }

  function startVoice(){
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "ru-RU";
    recognition.start();
    recognition.onresult = (e)=>{
      const text = e.results[0][0].transcript;
      chatInput.value=text;
      sendMessage();
    };
    recognition.onerror=()=>alert("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è");
  }

  chatInput.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  window.addEventListener("load",()=>{
    setTimeout(()=>{
      if(messages.length===0){
        appendMessage("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø —é—Ä–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ê–Ω–Ω–∞. –ì–æ—Ç–æ–≤–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤—Å–µ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?", false);
      }
    },1000);
  });

  // === –§–æ—Ä–º–∞ ===
  IMask(document.getElementById("leadPhone"), { mask: "+{7} (000) 000-00-00" });

  function openLeadForm(){
    document.getElementById("leadOverlay").style.display="block";
    document.getElementById("leadPopup").style.display="block";
  }

  document.getElementById("leadOverlay").addEventListener("click", closeLeadForms);
  function closeLeadForms(){
    document.getElementById("leadOverlay").style.display="none";
    document.getElementById("leadPopup").style.display="none";
    document.getElementById("leadThanks").style.display="none";
  }

  document.getElementById("leadSubmitBtn").addEventListener("click", async ()=>{
    const name = document.getElementById("leadName").value.trim();
    let phone = document.getElementById("leadPhone").value.replace(/\D/g,""); 

    if(!name || phone.length < 10){ 
      alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"); 
      return; 
    }

    phone = "+7" + phone.slice(-10);

    const payload = { name, phone, userId, messages, utm_source, utm_content };

    document.getElementById("leadPopup").style.display="none";
    document.getElementById("leadThanks").style.display="block";

    setTimeout(closeLeadForms, 3000);

    try {
      await fetch(LEAD_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
    }catch(e){ console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏",e); }
  });

  // === –ö–û–î –ö–í–ò–ó–ê –° –î–û–ë–ê–í–õ–ï–ù–ò–ï–ú 6-–ì–û –®–ê–ì–ê ===
  let step = 1;
  const total = 6; // –¢–µ–ø–µ—Ä—å 6 —à–∞–≥–æ–≤!
  const answers = {};
  const events = [];
  let last = Date.now();

  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const steps = $$(".step");
  const pText = $("#pText");
  const pBar = $("#pBar");
  const status = $("#status");

  function showStep(n){
    steps.forEach(s=>s.classList.remove("active"));
    steps[n-1].classList.add("active");
    pText.textContent = n+" / "+total;
    pBar.style.width = ((n-1)/(total-1))*100+"%";
    status.textContent = "–®–∞–≥ "+n+" –∏–∑ "+total;
    $("#prevBtn").disabled = n===1;
    $("#nextBtn").textContent = n<total ? "–î–∞–ª–µ–µ ‚Üí" : "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
  }

  function pushEvent(type,label){
    const now=Date.now();
    events.push({type,label,intervalMs:now-last,timestamp:now});
    last=now;
  }

  // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è debug-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  function updateDebugInfo(quizData, antibotResult) {
    // –¢–∞–π–º–∏–Ω–≥–∏
    const duration = quizData.durationMs / 1000;
    const intervals = quizData.events.map(e => e.intervalMs || 0);
    const avgInterval = intervals.length ? intervals.reduce((a, b) => a + b) / intervals.length : 0;
    const fastClicks = quizData.events.filter(e => e.intervalMs < 150).length;
    
    document.getElementById('debugDuration').textContent = `‚Ä¢ –û–±—â–µ–µ –≤—Ä–µ–º—è: ${duration.toFixed(1)} —Å–µ–∫`;
    document.getElementById('debugAvgInterval').textContent = `‚Ä¢ –°—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: ${Math.round(avgInterval)} –º—Å`;
    document.getElementById('debugFastClicks').textContent = `‚Ä¢ –ë—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–∫–∏: ${fastClicks}`;
    
    // –°–æ–±—ã—Ç–∏—è
    const clicks = quizData.events.filter(e => e.type === 'click' && e.label).length;
    const hasPaste = quizData.events.some(e => e.type === 'paste');
    const hasFakeClick = quizData.events.some(e => e.type === 'fake_click');
    
    document.getElementById('debugClicks').textContent = `‚Ä¢ –ö–ª–∏–∫–∏: ${clicks}`;
    document.getElementById('debugPaste').textContent = `‚Ä¢ –í—Å—Ç–∞–≤–∫–∞ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω: ${hasPaste ? '–î–ê ‚ö†Ô∏è' : '–ù–ï–¢ ‚úÖ'}`;
    document.getElementById('debugFakeClick').textContent = `‚Ä¢ –ù–µ–≤–∏–¥–∏–º–∞—è –∫–Ω–æ–ø–∫–∞: ${hasFakeClick ? '–ù–ê–ñ–ê–¢–ê üö®' : '–ù–ï–¢ ‚úÖ'}`;
    
    // –û—Ü–µ–Ω–∫–∞ –∞–Ω—Ç–∏–±–æ—Ç–∞
    if (antibotResult) {
      document.getElementById('debugHeuristic').textContent = `‚Ä¢ –≠–≤—Ä–∏—Å—Ç–∏–∫–∏: ${antibotResult.score || 0}/100`;
      document.getElementById('debugAI').textContent = `‚Ä¢ AI-–∞–Ω–∞–ª–∏–∑: ${antibotResult.aiScore || 'N/A'}`;
      document.getElementById('debugVerdict').textContent = `‚Ä¢ –í–µ—Ä–¥–∏–∫—Ç: ${antibotResult.action?.toUpperCase() || '‚Äî'}`;
      document.getElementById('debugReasons').textContent = `‚Ä¢ ${antibotResult.reason || '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω'}`;
      
      // –°—Ç–∞—Ç—É—Å
      const statusEl = document.getElementById('debugStatus');
      if (antibotResult.action === 'allow') {
        statusEl.innerHTML = '‚úÖ <strong>–ß–ï–õ–û–í–ï–ö</strong> - –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ';
        statusEl.style.background = '#ecfdf5';
        statusEl.style.color = '#065f46';
      } else if (antibotResult.action === 'challenge') {
        statusEl.innerHTML = '‚ö†Ô∏è <strong>–ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û</strong> - —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞';
        statusEl.style.background = '#fffbeb';
        statusEl.style.color = '#92400e';
      } else {
        statusEl.innerHTML = '‚õîÔ∏è <strong>–ë–û–¢</strong> - –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –±–æ—Ç-–ø—Ä–∏–∑–Ω–∞–∫–∏';
        statusEl.style.background = '#fef2f2';
        statusEl.style.color = '#dc2626';
      }
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∫–≤–∏–∑–∞
  function restartQuiz() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å—ë
    step = 1;
    answers = {};
    events.length = 0;
    last = Date.now();
    
    // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    document.querySelectorAll('.btn-opt').forEach(btn => btn.classList.remove('active'));
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
    document.getElementById('quizName').value = '';
    document.getElementById('quizPhone').value = '';
    document.getElementById('quizHoneypot').value = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —à–∞–≥
    showStep(1);
  }

  // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–∞–π—Ç
  function goToPricing() {
    window.open('https://—Ç–≤–æ–π-—Å–∞–π—Ç.—Ä—É#try', '_blank');
  }

  $$(".btn-opt").forEach(btn=>{
    btn.onclick=()=>{
      const name=btn.dataset.name,val=btn.dataset.value;
      btn.parentElement.querySelectorAll(".btn-opt").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      answers[name]=val;
      pushEvent("click",name+":"+val);
      if(step<4) setTimeout(()=>showStep(++step),200);
    };
  });

  $("#prevBtn").onclick=()=>{if(step>1)showStep(--step);}

  $("#nextBtn").onclick=async()=>{
    if(step<4){showStep(++step);return;}
    if(step===4){showStep(++step);}
    else if(step === 5){
      const name=$("#quizName").value.trim();
      let phone=$("#quizPhone").value.replace(/[^0-9+]/g,"");
      const honeypot=$("#quizHoneypot").value;
      if(phone&&!phone.startsWith("+7"))phone="+7"+phone.replace(/^8/,"").slice(-10);
      if(!name||phone.length<12)return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");

      $("#nextBtn").disabled=true;
      $("#nextBtn").textContent="–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶";

      const userId=localStorage.getItem("userId")||("user_"+Math.random().toString(36).slice(2,10));
      localStorage.setItem("userId",userId);
      
      const payload={userId,answers,events,phone,honeypot,durationMs:Date.now()-events[0]?.timestamp||0};
      
      try{
        const r=await fetch(QUIZ_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        const d=await r.json();
        console.log("ANTIBOT DEBUG:", d);
        
        // –ü–û–ö–ê–ó–´–í–ê–ï–ú –®–ê–ì 6 –° –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú–ò
        showStep(6);
        updateDebugInfo(payload, d);
        
        if(d.action !== "deny") {
          const answersSummary = Object.entries(answers).map(([q,a]) => `${q}: ${a}`).join("; ");
          await fetch(LEAD_URL,{method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              name,
              phone,
              userId,
              source: "quiz",
              no_summary: true,
              answersSummary: answersSummary,
              messages: []
            })});
        }
        $("#nextBtn").textContent="–ì–æ—Ç–æ–≤–æ ‚úî";
      }catch(e){
        alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
        $("#nextBtn").textContent="–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
      }
      finally{
        $("#nextBtn").disabled=false;
      }
    }
  };

  showStep(1);

  // === –ú–ê–°–ö–ê –¢–ï–õ–ï–§–û–ù–ê –ò DETECTOR PASTE ===
  const phoneInput = document.getElementById("quizPhone");
  const mask = IMask(phoneInput, {
    mask: '+{7} (000) 000-00-00',
    lazy: false,
    placeholderChar: '_'
  });

  phoneInput.addEventListener('input', () => {
    const digits = phoneInput.value.replace(/\D/g, '');
    if (digits[1] && digits[1] !== '9') {
      const corrected = '+7 (9' + digits.slice(2, 11).padEnd(9, '_');
      phoneInput.value = corrected.replace(/_/g, '');
      mask.updateValue();
    }
  });

  phoneInput.addEventListener('paste', (e) => {
    pushEvent("paste", "phone");
  });
</script>
</body>
</html>
