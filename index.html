<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>РџСЂРѕРІРµСЂРєР° РЅР° Р±Р°РЅРєСЂРѕС‚СЃС‚РІРѕ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- РљРћРќР¤РР“РЈР РђР¦РРЇ РќРћР’РћР“Рћ РђРќРўРР‘РћРў-SDK -->
  <script>
        window.GIGABOT_CONFIG = {
          endpoint: "https://gigabot-db4r.onrender.com",
          adminEndpoint: "https://gigabot-admin-biea.onrender.com",
          siteId: "site_anti_bot_quiz_zzxj_onrender_co",
          publicKey: "pk_live_655194bbe8c403f79160085c",
          mirrors: [
            {
              endpoint: "https://gigabot-ix8g.onrender.com",
              adminEndpoint: "https://gigabot-admin-vid9.onrender.com",
              siteId: "site_anti_bot_quiz_zzxj_onrender_co",
              publicKey: "pk_live_655194bbe8c403f79160085c"
            }
          ]
        };
      </script>
      <script src="https://gigabot-admin-biea.onrender.com/gigabot.js" defer></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f7f9fb; color: #333; line-height: 1.6; }

    /* === РљР’РР— FLEXBE РЎРўРР›Р¬ === */
.quiz-wrapper * { all: unset; display: revert; box-sizing: border-box; }

.quiz-wrapper{
  min-height:100svh; display:flex; align-items:center; justify-content:center;
  padding:24px; background:linear-gradient(180deg,#f6f9fc 0%,#eef3f8 100%);
}
.quiz{
  width:min(880px,96vw); background:#fff; border-radius:20px;
  box-shadow:0 20px 60px rgba(10,61,98,.15); overflow:hidden;
  display:grid; grid-template-columns:1fr;
}
.quiz__header{
  background:#0a3d62; color:#fff; padding:18px 22px; display:flex; align-items:center; gap:12px;
}
.quiz__logo{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.15);display:grid;place-items:center;font-weight:700;}
.quiz__title{font-weight:800;}
.quiz__progress{margin-left:auto;display:flex;align-items:center;gap:10px;font-size:13px;opacity:.9;}
.bar{width:160px;height:8px;border-radius:999px;background:rgba(255,255,255,.25);overflow:hidden;}
.bar>span{display:block;height:100%;background:#fff;width:0%}
.quiz__body{padding:28px 28px 22px;}
.step{display:none;animation:fade .35s ease;}
.step.active{display:block;}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.q{font-size:22px;font-weight:800;color:#0a3d62;margin-bottom:16px;}
.options{display:grid;gap:12px;grid-template-columns:repeat(3,1fr);}
.btn-opt{border:1px solid #e7eef7;border-radius:14px;padding:16px 14px;background:#f8fbff;cursor:pointer;text-align:center;transition:.2s;font-weight:600;}
.btn-opt:hover{transform:translateY(-1px);background:#f0f6ff;}
.btn-opt.active{outline:2px solid #0a3d62;background:#e8f3ff;}
.controls{display:flex;gap:10px;justify-content:space-between;margin-top:22px;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 18px;border-radius:12px;border:1px solid #e7eef7;background:#fff;cursor:pointer;transition:.2s;font-weight:700;}
.btn--primary{background:#ff6b6b;color:#fff;border-color:transparent;}
.btn--primary:hover{filter:brightness(.98);transform:translateY(-1px);}
.muted{color:#6b7a90;font-size:13px;margin-top:6px;}
.lead{display:grid;gap:12px;grid-template-columns:1fr 1fr;}
.field{display:grid;gap:8px;}
.input{padding:14px 12px;border-radius:12px;border:1px solid #e7eef7;font-size:16px;background:#f9fbfd;}
.result{border:1px dashed #e7eef7;padding:14px;border-radius:12px;background:#fbfdff;margin-top:10px;font-size:14px;}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700;}
.ok{background:#e9f7f0;color:#18a957;}
.warn{background:#fff6e5;color:#996b00;}
.deny{background:#ffeaea;color:#d9534f;}
.footer{padding:14px 22px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-top:1px solid #e7eef7;background:#fcfdff;}
.hint{font-size:12px;color:#6b7a90}
.debug-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; margin-bottom: 16px; }
.debug-section { margin-bottom: 12px; }
.debug-title { font-weight: 600; margin-bottom: 6px; color: #0a3d62; }
.debug-line { margin-bottom: 4px; }
.debug-status { margin-top: 12px; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 14px; }
.final-loading{display:none;margin-top:14px;padding:12px;border:1px solid #e7eef7;border-radius:10px;background:#fff;text-align:center}
.final-loading.active{display:block}
.final-spinner{display:inline-block;width:20px;height:20px;border:3px solid #dbe7f5;border-top-color:#0a3d62;border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:680px){
  .options{grid-template-columns:1fr}
  .lead{grid-template-columns:1fr}
  .quiz__header{flex-wrap:wrap;gap:8px}
  .quiz__progress{width:100%}
  .bar{flex:1}
  .debug-grid { grid-template-columns: 1fr; }
}
    /* Chat block */
    .chat-container {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      height: 500px;
      overflow: hidden;
      border: 1px solid #e8e8e8;
    }
    .chat-header {
      background: #0a3d62;
      color: white;
      padding: 15px 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .chat-header img {
      width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex: 0 0 40px;
    }
    .chat-header .title { font-size: 16px; font-weight: 700; }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: #f8fafc;
    }
    .message {
      max-width: 80%;
      padding: 12px 18px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.5;
    }
    .bot {
      background: #eef4f9;
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }
    .user {
      background: #ff6b6b;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }
    .chat-suggestions {
      padding: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      border-top: 1px solid #e8e8e8;
      background: #f5f7fa;
    }
    .chat-suggestions button {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background: #eef4f9;
      cursor: pointer;
      font-size: 13px;
      transition: 0.3s;
      color: #0a3d62;
    }
    .chat-suggestions button:hover {
      background: #d6e4f0;
    }
    .chat-input {
      display: flex;
      border-top: 1px solid #e8e8e8;
    }
    .chat-input input {
      flex: 1;
      padding: 16px;
      border: none;
      outline: none;
      font-size: 15px;
    }
    .chat-input button {
      padding: 0 20px;
      border: none;
      background: #ff6b6b;
      color: white;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.3s;
    }
    .chat-input button:hover { background: #ff4b4b; }
    .chat-input button svg { width: 20px; height: 20px; fill: white; }

    #typingIndicator {
      font-style: italic;
      display: none;
      align-self: flex-start;
      margin-left: 10px;
    }
    #typingIndicator .dot {
      animation: blink 1.2s infinite ease-in-out;
      opacity: 0.3;
    }
    #typingIndicator .dot:nth-child(2){animation-delay:0.2s;}
    #typingIndicator .dot:nth-child(3){animation-delay:0.4s;}
    @keyframes blink {
      0%,80%,100%{opacity:0.3;}
      40%{opacity:1;}
    }

    /* Popup form */
    #leadOverlay {
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,0.6); z-index:9998;
    }
    #leadPopup, #leadThanks {
      display:none; position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#fff; color:#333; padding:30px;
      border-radius:16px; z-index:9999;
      max-width:400px; width:90%;
      box-shadow:0 0 30px rgba(0,0,0,0.4);
      text-align:center;
    }
    #leadPopup h3 { margin-bottom:20px; color:#0a3d62; font-size:22px; }
    #leadPopup input {
      width:100%; padding:12px; border-radius:8px;
      border:1px solid #ccc; margin-bottom:15px;
      font-size:16px;
    }
    #leadPopup button {
      width:100%; padding:14px;
      border:none; border-radius:8px;
      background-color:#ff6b6b; color:#fff;
      font-weight:bold; cursor:pointer; font-size:16px;
    }
    #leadPopup button:hover { background:#ff4b4b; }
    .chat-container,
    #leadOverlay,
    #leadPopup,
    #leadThanks {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- РўРћР›Р¬РљРћ РљР’РР— -->
  <div class="quiz-wrapper">
    <div class="quiz" id="quiz">
      <div class="quiz__header">
        <div class="quiz__logo">AU</div>
        <div class="quiz__title">РџСЂРѕРІРµСЂРєР° РЅР° Р±Р°РЅРєСЂРѕС‚СЃС‚РІРѕ</div>
        <div class="quiz__progress">
          <span id="pText">1 / 6</span>
          <div class="bar"><span id="pBar"></span></div>
        </div>
      </div>
      <div class="quiz__body">
        <div class="step active" data-step="1">
          <div class="q">1. РљР°РєР°СЏ Сѓ РІР°СЃ СЃСѓРјРјР° РґРѕР»РіР°?</div>
          <div class="options">
            <button class="btn-opt" data-name="debt" data-value="РґРѕ 300 С‚С‹СЃ.">Р”Рѕ 300 С‚С‹СЃ.</button>
            <button class="btn-opt" data-name="debt" data-value="300вЂ“500 С‚С‹СЃ.">300вЂ“500 С‚С‹СЃ.</button>
            <button class="btn-opt" data-name="debt" data-value="Р±РѕР»РµРµ 500 С‚С‹СЃ.">Р‘РѕР»РµРµ 500 С‚С‹СЃ.</button>
          </div>
        </div>

        <div class="step" data-step="2">
          <div class="q">2. Р•СЃС‚СЊ Р»Рё РїСЂРѕСЃСЂРѕС‡РєРё?</div>
          <div class="options">
            <button class="btn-opt" data-name="delay" data-value="РЅРµС‚">РќРµС‚</button>
            <button class="btn-opt" data-name="delay" data-value="РјРµРЅРµРµ 3 РјРµСЃ.">РњРµРЅРµРµ 3 РјРµСЃ.</button>
            <button class="btn-opt" data-name="delay" data-value="Р±РѕР»РµРµ 3 РјРµСЃ.">Р‘РѕР»РµРµ 3 РјРµСЃ.</button>
          </div>
        </div>

        <div class="step" data-step="3">
          <div class="q">3. Р Р°Р±РѕС‚Р°РµС‚Рµ РѕС„РёС†РёР°Р»СЊРЅРѕ?</div>
          <div class="options">
            <button class="btn-opt" data-name="job" data-value="РґР°">Р”Р°</button>
            <button class="btn-opt" data-name="job" data-value="РЅРµС‚">РќРµС‚</button>
          </div>
        </div>

        <div class="step" data-step="4">
          <div class="q">4. Р•СЃС‚СЊ Р»Рё РёРјСѓС‰РµСЃС‚РІРѕ РєСЂРѕРјРµ Р¶РёР»СЊСЏ?</div>
          <div class="options">
            <button class="btn-opt" data-name="property" data-value="РЅРµС‚">РќРµС‚</button>
            <button class="btn-opt" data-name="property" data-value="РµСЃС‚СЊ, С…РѕС‡Сѓ СЃРѕС…СЂР°РЅРёС‚СЊ">Р•СЃС‚СЊ, С…РѕС‡Сѓ СЃРѕС…СЂР°РЅРёС‚СЊ</button>
            <button class="btn-opt" data-name="property" data-value="РіРѕС‚РѕРІ РїСЂРѕРґР°С‚СЊ">Р“РѕС‚РѕРІ РїСЂРѕРґР°С‚СЊ</button>
          </div>
        </div>

        <div class="step" data-step="5">
          <div class="q">5. РћСЃС‚Р°РІСЊС‚Рµ РєРѕРЅС‚Р°РєС‚ РґР»СЏ СЂРµР·СѓР»СЊС‚Р°С‚Р°</div>
          <div class="lead" id="leadForm">
            <div class="field">
              <label>Р’Р°С€Рµ РёРјСЏ</label>
              <input id="quizName" name="name" class="input" placeholder="РРІР°РЅ">
            </div>
            <div class="field">
              <label>РўРµР»РµС„РѕРЅ</label>
              <input id="quizPhone" name="phone" class="input" placeholder="+7 900 000-00-00">
            </div>
          </div>
          <div class="result" id="summaryBox" style="display:none;"></div>
        </div>

        <div class="step" data-step="6">
          <div class="q">вњ… РћС‚РїСЂР°РІРєР° Р·Р°РІРµСЂС€РµРЅР°</div>
          
          <div class="result" style="display:block; background:#f8fafc; border:1px solid #e2e8f0;">
            <div style="margin-bottom:16px; font-weight:600; color:#0a3d62;">вњ… РЎРїР°СЃРёР±Рѕ Р·Р° Р·Р°СЏРІРєСѓ!</div>
            
            <div style="padding:12px; text-align:center;">
              <p>Р’Р°С€Рё РґР°РЅРЅС‹Рµ РѕС‚РїСЂР°РІР»РµРЅС‹ РЅР° РїСЂРѕРІРµСЂРєСѓ.</p>
              <p style="margin-top:10px; font-size:14px; color:#6b7a90;">
                РђРЅС‚РёР±РѕС‚-SDK РѕР±СЂР°Р±РѕС‚Р°Р» РІР°С€Сѓ Р·Р°СЏРІРєСѓ Рё РїРµСЂРµРґР°Р» РґР°РЅРЅС‹Рµ РІ СЃРёСЃС‚РµРјСѓ.
              </p>
            </div>
            <div id="finalLoading" class="final-loading"><span class="final-spinner"></span><span id="finalLoadingText">Идет проверка данных...</span></div>
          </div>
        </div>
        <div class="controls">
          <button class="btn btn--ghost" id="prevBtn" disabled>в†ђ РќР°Р·Р°Рґ</button>
          <button class="btn btn--primary" id="nextBtn">Р”Р°Р»РµРµ в†’</button>
        </div>
        <div class="muted">РћС‚РІРµС‚СЊС‚Рµ РЅР° 5 РІРѕРїСЂРѕСЃРѕРІ, С‡С‚РѕР±С‹ РїСЂРѕРІРµСЂРёС‚СЊ РІРѕР·РјРѕР¶РЅРѕСЃС‚СЊ Р±Р°РЅРєСЂРѕС‚СЃС‚РІР°</div>
      </div>
      <div class="footer">
        <div class="hint">РђРЅС‚РёР±РѕС‚ РІРєР»СЋС‡С‘РЅ вЂў РџРѕРІРµРґРµРЅРёРµ Р°РЅР°Р»РёР·РёСЂСѓРµС‚СЃСЏ</div>
        <div class="hint" id="status">РЁР°Рі 1 РёР· 6</div>
      </div>
    </div>
  </div>

  <!-- РўРћР›Р¬РљРћ Р”РРђР›РћР“РћР’РћР• РћРљРќРћ -->
  <div class="chat-container">
    <div class="chat-header">
        <img src="https://i.imgur.com/VnE8ZUa.png" alt="РђРЅРЅР°">
        <div class="title">РЎРїРµС†РёР°Р»РёСЃС‚ РїРѕ Р°РЅС‚РёР±РѕС‚-Р·Р°С‰РёС‚Рµ</div>
      </div>
    <div class="chat-messages" id="chat"></div>
    <div id="typingIndicator" style="display:none; padding:10px 20px; font-size:14px; color:#0a3d62;">
      РђРЅРЅР° РїРµС‡Р°С‚Р°РµС‚<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
    </div>
    <div class="chat-suggestions">
        <button onclick="quickSend('РљР°Рє СЂР°Р±РѕС‚Р°РµС‚ Р°РЅС‚РёР±РѕС‚-Р·Р°С‰РёС‚Р°?')">РџСЂРёРЅС†РёРї СЂР°Р±РѕС‚С‹</button>
        <button onclick="quickSend('РљР°РєРёРµ С‚РёРїС‹ Р±РѕС‚РѕРІ РѕРїСЂРµРґРµР»СЏРµС‚Рµ?')">РўРёРїС‹ Р±РѕС‚РѕРІ</button>
        <button onclick="quickSend('РЎРєРѕР»СЊРєРѕ СЃС‚РѕРёС‚ РїРѕРґРєР»СЋС‡РµРЅРёРµ?')">РЎС‚РѕРёРјРѕСЃС‚СЊ</button>
      </div>
    <div class="chat-input">
      <button onclick="startVoice()" title="Р“РѕРІРѕСЂРёС‚СЊ">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M192 256c0 17.7-14.3 32-32 32s-32-14.3-32-32V128c0-17.7 14.3-32 32-32s32 14.3 32 32V256zM160 320c35.3 0 64-28.7 64-64V128a64 64 0 1 0-128 0V256c0 35.3 28.7 64 64 64zm56 32H104c-13.3 0-24 10.7-24 24s10.7 24 24 24h24v56c0 13.3 10.7 24 24 24s24-10.7 24-24V400h24c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/></svg>
      </button>
      <input type="text" id="chatInput" placeholder="Р’РІРµРґРёС‚Рµ РІР°С€ РІРѕРїСЂРѕСЃ...">
      <button onclick="sendMessage()">РћС‚РїСЂР°РІРёС‚СЊ</button>
    </div>
  </div>

  <!-- Overlay + Form + Thanks -->
  <div id="leadOverlay"></div>

  <div id="leadPopup">
    <h3 id="leadTitle">РћСЃС‚Р°РІСЊС‚Рµ Р·Р°СЏРІРєСѓ РЅР° РєРѕРЅСЃСѓР»СЊС‚Р°С†РёСЋ</h3>
    <form id="popupForm">
      <input name="name" id="leadName" placeholder="Р’Р°С€Рµ РёРјСЏ">
      <input name="phone" id="leadPhone" placeholder="+7 (___) ___-__-__">
      <button type="submit" id="leadSubmitBtn">РџРѕР»СѓС‡РёС‚СЊ РєРѕРЅСЃСѓР»СЊС‚Р°С†РёСЋ</button>
    </form>
  </div>

  <div id="leadThanks">
    <div style="font-size: 18px; padding: 20px;">вњ… РЎРїР°СЃРёР±Рѕ Р·Р° Р·Р°СЏРІРєСѓ!<br>РњС‹ СЃРІСЏР¶РµРјСЃСЏ СЃ РІР°РјРё РІ С‚РµС‡РµРЅРёРµ 15 РјРёРЅСѓС‚</div>
  </div>

<script src="https://unpkg.com/imask"></script>
<script>
  // ============================
  // РЈР”РђР›Р•Рќ РЎРўРђР Р«Р™ РђРќРўРР‘РћРў РљРћР”
  // ============================
  
  // РЈР”РђР›Р•РќР«: QUIZ_URL, OPENAI_PROXY_URL, LEAD_URL (РѕСЃС‚Р°Р»РёСЃСЊ С‚РѕР»СЊРєРѕ РґР»СЏ С‡Р°С‚Р°)
  const OPENAI_PROXY_URL = "https://openai-gpt-proxy-d2py.onrender.com/gpt";
  const LEAD_URL = "https://openai-gpt-proxy-d2py.onrender.com/lead";
  
  // РЈР”РђР›Р•РќР«: РїРѕРІРµРґРµРЅС‡РµСЃРєРёРµ РґР°РЅРЅС‹Рµ (mouseMovements, questionTimings, clickPositions)
  // РЈР”РђР›Р•РќР«: С„СѓРЅРєС†РёРё calculateHeuristicScore, updateDebugInfo, behaviorData
  
  // ============================
  // РћРЎРўРђР’Р›Р•Рќ Р§РђРў
  // ============================
  let messages = [];
  const chatBox = document.getElementById("chat");
  const chatInput = document.getElementById("chatInput");

  let userId = localStorage.getItem("userId") || "user_" + Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId", userId);

  let startTime = Date.now();

  const urlParams = new URLSearchParams(window.location.search);
  const utm_source = urlParams.get("utm_source") || "";
  const utm_content = urlParams.get("utm_content") || "";

  function appendMessage(text, fromUser=false){
    const div = document.createElement("div");
    div.className = "message " + (fromUser ? "user" : "bot");
    div.textContent = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function typeMessage(text) {
    const typingIndicator = document.getElementById("typingIndicator");
    typingIndicator.style.display = "block";

    const delay = Math.min(2500, 500 + text.length * 25); 
    await new Promise(r => setTimeout(r, delay));

    typingIndicator.style.display = "none";
    appendMessage(text, false);
    messages.push({ role: "assistant", content: text });
  }

  async function sendMessage() {
    const text = chatInput.value.trim();
    if (!text) return;

    appendMessage(text, true);
    messages.push({ role: "user", content: text });
    chatInput.value = "";

    try {
      const res = await fetch(OPENAI_PROXY_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages, userId, mode: "antibot" })
      });
      const data = await res.json();
      let reply = data.choices?.[0]?.message?.content || "РћС€РёР±РєР°";

      if (/\[openLeadForm\]/i.test(reply) || data.triggerForm) {
        const clean = reply.replace(/\[openLeadForm\]/gi, "").trim();
        document.getElementById("leadTitle").innerText = clean || "РћСЃС‚Р°РІСЊС‚Рµ Р·Р°СЏРІРєСѓ РЅР° РєРѕРЅСЃСѓР»СЊС‚Р°С†РёСЋ";
        openLeadForm();
        reply = clean;
      }

      await typeMessage(reply);

      if (reply.includes("[nextMessage]")) {
        const parts = reply.split("[nextMessage]").map(t => t.trim()).filter(Boolean);
        if (parts.length > 1) {
          const first = parts[0];
          const second = parts[1];

          chatBox.lastChild.textContent = first;

          const thinkingDelay = 1500 + Math.random() * 1000;
          setTimeout(async () => {
            await typeMessage(second);
          }, thinkingDelay);
        }
      }

    } catch (e) {
      appendMessage("РћС€РёР±РєР° СЃРѕРµРґРёРЅРµРЅРёСЏ", false);
    }
  }

  function quickSend(text){
    chatInput.value=text;
    sendMessage();
  }

  function startVoice(){
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "ru-RU";
    recognition.start();
    recognition.onresult = (e)=>{
      const text = e.results[0][0].transcript;
      chatInput.value=text;
      sendMessage();
    };
    recognition.onerror=()=>alert("РћС€РёР±РєР° СЂР°СЃРїРѕР·РЅР°РІР°РЅРёСЏ");
  }

  chatInput.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  window.addEventListener("load",()=>{
    setTimeout(()=>{
      if(messages.length===0){
        appendMessage("Р—РґСЂР°РІСЃС‚РІСѓР№С‚Рµ! РЇ СЃРїРµС†РёР°Р»РёСЃС‚ РїРѕ Р°РЅС‚РёР±РѕС‚-Р·Р°С‰РёС‚Рµ. Р“РѕС‚РѕРІР° СЂР°СЃСЃРєР°Р·Р°С‚СЊ Рѕ С‚РѕРј, РєР°Рє РјС‹ С„РёР»СЊС‚СЂСѓРµРј Р±РѕС‚РѕРІ РІ С„РѕСЂРјР°С… Рё РєРІРёР·Р°С…, С‡С‚РѕР±С‹ РІС‹ РїРѕР»СѓС‡Р°Р»Рё С‚РѕР»СЊРєРѕ С‡РёСЃС‚С‹Рµ Р»РёРґС‹. Р§РµРј РјРѕРіСѓ РїРѕРјРѕС‡СЊ?", false);
      }
    },1000);
  });

  // ============================
  // РџРћРџРђРџ Р¤РћР РњРђ (РѕСЃС‚Р°РІР»РµРЅР° РєР°Рє РµСЃС‚СЊ)
  // ============================
  IMask(document.getElementById("leadPhone"), { mask: "+{7} (000) 000-00-00" });

  function openLeadForm(){
    document.getElementById("leadOverlay").style.display="block";
    document.getElementById("leadPopup").style.display="block";
  }

  document.getElementById("leadOverlay").addEventListener("click", closeLeadForms);
  function closeLeadForms(){
    document.getElementById("leadOverlay").style.display="none";
    document.getElementById("leadPopup").style.display="none";
    document.getElementById("leadThanks").style.display="none";
  }

  // Р¤РѕСЂРјР° РІ РїРѕРїР°РїРµ С‚РµРїРµСЂСЊ Р±СѓРґРµС‚ РѕР±СЂР°Р±Р°С‚С‹РІР°С‚СЊСЃСЏ gigabot.js
  document.getElementById("popupForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    
    const name = document.getElementById("leadName").value.trim();
    let phone = document.getElementById("leadPhone").value.replace(/\D/g,""); 

    if(!name || phone.length < 10){ 
      alert("Р’РІРµРґРёС‚Рµ РёРјСЏ Рё РєРѕСЂСЂРµРєС‚РЅС‹Р№ РЅРѕРјРµСЂ С‚РµР»РµС„РѕРЅР°"); 
      return; 
    }

    phone = "+7" + phone.slice(-10);

    const payload = { name, phone, userId, messages, utm_source, utm_content };

    document.getElementById("leadPopup").style.display="none";
    document.getElementById("leadThanks").style.display="block";

    setTimeout(closeLeadForms, 3000);

    try {
      await fetch(LEAD_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
    }catch(e){ console.error("РћС€РёР±РєР° РѕС‚РїСЂР°РІРєРё",e); }
  });

    // ============================
  // РљРћР” РљР’РР—Рђ (РЈРџР РћР©Р•Рќ)
  // ============================
  let step = 1;
  const total = 6;
  const answers = {};
  const events = [];
  
  // РЎРћР‘РР РђР•Рњ РЎРћР‘Р«РўРРЇ Р”Р›РЇ РђРќРўРР‘РћРўРђ
  document.addEventListener('click', (e) => {
    events.push({
      type: 'click',
      timestamp: Date.now(),
      label: e.target.tagName
    });
  });

  document.addEventListener('input', (e) => {
    if (e.target.tagName === 'INPUT') {
      events.push({
        type: 'input',
        timestamp: Date.now(),
        label: e.target.name || e.target.id
      });
    }
  });

  document.addEventListener('paste', (e) => {
    events.push({
      type: 'paste',
      timestamp: Date.now(),
      label: 'paste'
    });
  });

  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const steps = $$(".step");
  const pText = $("#pText");
  const pBar = $("#pBar");
  const status = $("#status");

  function showStep(n){
    if (step > 1) recordQuestionTime();
    steps.forEach(s=>s.classList.remove("active"));
    steps[n-1].classList.add("active");
    pText.textContent = n+" / "+total;
    pBar.style.width = ((n-1)/(total-1))*100+"%";
    status.textContent = "РЁР°Рі "+n+" РёР· "+total;
    $("#prevBtn").disabled = n===1;
    
    if(n === 6) {
      $("#nextBtn").style.display = "none";
    } else {
      $("#nextBtn").style.display = "inline-flex";
      $("#nextBtn").textContent = n<5 ? "Р”Р°Р»РµРµ в†’" : "РћС‚РїСЂР°РІРёС‚СЊ";
    }
  }

  function recordQuestionTime() {
    // РњРёРЅРёРјР°Р»СЊРЅР°СЏ Р»РѕРіРёРєР° РґР»СЏ СЃРѕРІРјРµСЃС‚РёРјРѕСЃС‚Рё
  }

  function goToPricing() {
    window.open('https://С‚РІРѕР№-СЃР°Р№С‚.СЂСѓ#try', '_blank');
  }

  function renderFinalResult(data) {
  const step6Result = document.querySelector('.step[data-step="6"] .result');
  if (!step6Result) return;
  
  // РЈРґР°Р»СЏРµРј СЃС‚Р°СЂСѓСЋ РїР°РЅРµР»СЊ РµСЃР»Рё РµСЃС‚СЊ
  const oldPanel = document.getElementById("finalDetails");
  if (oldPanel) oldPanel.remove();
  
  // РЎРѕР·РґР°РµРј РЅРѕРІСѓСЋ РїРёР·РґР°С‚СѓСЋ РїР°РЅРµР»СЊ
  const panel = document.createElement("div");
  panel.id = "finalDetails";
  panel.style.marginTop = "20px";
  panel.style.padding = "0";
  panel.style.background = "#fff";
  panel.style.border = "1px solid #e7eef7";
  panel.style.borderRadius = "16px";
  panel.style.fontSize = "14px";
  panel.style.textAlign = "left";
  panel.style.overflow = "hidden";
  
  // Р—Р°РіРѕР»РѕРІРѕРє СЂРµР·СѓР»СЊС‚Р°С‚Р°
  const actionColor = data.action === 'allow' ? '#10b981' : (data.action === 'deny' || data.action === 'block' ? '#ef4444' : '#f59e0b');
  const actionText = data.action === 'allow' ? 'вњ“ Р§Р•Р›РћР’Р•Рљ' : (data.action === 'deny' || data.action === 'block' ? 'вњ— Р‘РћРў' : 'вљ  РЎРћРњРќРРўР•Р›Р¬РќРћ');
  
  // РР·РІР»РµРєР°РµРј РґР°РЅРЅС‹Рµ РёР· events РµСЃР»Рё РµСЃС‚СЊ
  const events = data._events || [];
  const intervals = events.map(e => e.intervalMs).filter(i => i > 0);
  const avgInterval = intervals.length ? Math.round(intervals.reduce((a,b) => a+b, 0) / intervals.length) : 0;
  const minInterval = intervals.length ? Math.min(...intervals) : 0;
  const maxInterval = intervals.length ? Math.max(...intervals) : 0;
  const intervalVariance = intervals.length > 1 ? Math.round(calculateVariance(intervals)) : 0;
  
  // РџРѕРґСЃС‡РµС‚ С‚РёРїРѕРІ СЃРѕР±С‹С‚РёР№
  const pasteCount = events.filter(e => e.type === 'paste').length;
  const clickCount = events.filter(e => e.type === 'click' || e.type === 'mousedown').length;
  const inputCount = events.filter(e => e.type === 'input').length;
  
  // Р¤РѕСЂРјР°С‚РёСЂРѕРІР°РЅРёРµ РІСЂРµРјРµРЅРё
  const durationSec = data.durationMs ? Math.round(data.durationMs / 1000) : 0;
  
  // РЎРѕР±РёСЂР°РµРј HTML
  panel.innerHTML = `
    <div style="background:${actionColor}; color:white; padding:16px; font-weight:700; font-size:18px; display:flex; justify-content:space-between; align-items:center;">
      <span>${actionText}</span>
      <span style="background:rgba(255,255,255,0.2); padding:4px 12px; border-radius:999px; font-size:14px;">Score: ${data.score || 0}</span>
    </div>
    
    <div style="padding:16px; border-bottom:1px solid #eef2f6;">
      <div style="font-weight:600; color:#0a3d62; margin-bottom:8px;">рџ“Љ РћРЎРќРћР’РќР«Р• РџРђР РђРњР•РўР Р«</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
        <div style="background:#f8fafc; padding:10px; border-radius:8px;">
          <div style="color:#6b7a90; font-size:12px;">РЎС‚Р°С‚СѓСЃ РїСЂРѕРІРµСЂРєРё</div>
          <div style="font-weight:600; color:${actionColor};">${data.action || 'unknown'}</div>
        </div>
        <div style="background:#f8fafc; padding:10px; border-radius:8px;">
          <div style="color:#6b7a90; font-size:12px;">РџСЂРёС‡РёРЅР°</div>
          <div style="font-weight:500;">${data.reason || 'вЂ”'}</div>
        </div>
        <div style="background:#f8fafc; padding:10px; border-radius:8px;">
          <div style="color:#6b7a90; font-size:12px;">РСЃС‚РѕС‡РЅРёРє Р°РЅР°Р»РёР·Р°</div>
          <div style="font-weight:500;">${data.analysisSource || 'heuristic'}</div>
        </div>
        <div style="background:#f8fafc; padding:10px; border-radius:8px;">
          <div style="color:#6b7a90; font-size:12px;">User ID</div>
          <div style="font-weight:500; font-family:monospace; font-size:12px;">${data.userId || 'вЂ”'}</div>
        </div>
      </div>
    </div>
    
    <div style="padding:16px; border-bottom:1px solid #eef2f6;">
      <div style="font-weight:600; color:#0a3d62; margin-bottom:8px;">рџ‘¤ РўР•РҐРќРР§Р•РЎРљРР• Р”РђРќРќР«Р•</div>
      <div style="display:grid; grid-template-columns:1fr 2fr; gap:4px 8px; background:#f8fafc; padding:10px; border-radius:8px;">
        <div style="color:#6b7a90;">IP-Р°РґСЂРµСЃ:</div><div style="font-family:monospace;">${data.ip || 'вЂ”'}</div>
        <div style="color:#6b7a90;">User-Agent:</div><div style="font-size:11px; overflow:hidden; text-overflow:ellipsis;">${data.ua ? data.ua.substring(0,60)+'...' : 'вЂ”'}</div>
        <div style="color:#6b7a90;">UTM source:</div><div>${data.utm?.utm_source || data.utm_source || 'вЂ”'}</div>
        <div style="color:#6b7a90;">UTM campaign:</div><div>${data.utm?.utm_campaign || data.utm_campaign || 'вЂ”'}</div>
      </div>
    </div>
    
    <div style="padding:16px; border-bottom:1px solid #eef2f6;">
      <div style="font-weight:600; color:#0a3d62; margin-bottom:8px;">вЏ±пёЏ РЎРљРћР РћРЎРўР¬ Р—РђРџРћР›РќР•РќРРЇ (${durationSec} СЃРµРє)</div>
      <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-bottom:8px;">
        <div style="background:#f8fafc; padding:8px; border-radius:6px; text-align:center;">
          <div style="color:#6b7a90; font-size:11px;">РЎСЂРµРґРЅРёР№ РёРЅС‚РµСЂРІР°Р»</div>
          <div style="font-weight:700; font-size:16px;">${avgInterval}ms</div>
        </div>
        <div style="background:#f8fafc; padding:8px; border-radius:6px; text-align:center;">
          <div style="color:#6b7a90; font-size:11px;">РњРёРЅ/РњР°РєСЃ</div>
          <div style="font-weight:700; font-size:14px;">${minInterval}/${maxInterval}ms</div>
        </div>
        <div style="background:#f8fafc; padding:8px; border-radius:6px; text-align:center;">
          <div style="color:#6b7a90; font-size:11px;">Р’Р°СЂРёР°С‚РёРІРЅРѕСЃС‚СЊ</div>
          <div style="font-weight:700; font-size:14px; color:${intervalVariance < 100 ? '#ef4444' : '#10b981'};">${intervalVariance}</div>
        </div>
        <div style="background:#f8fafc; padding:8px; border-radius:6px; text-align:center;">
          <div style="color:#6b7a90; font-size:11px;">Р’СЃРµРіРѕ СЃРѕР±С‹С‚РёР№</div>
          <div style="font-weight:700; font-size:16px;">${events.length}</div>
        </div>
      </div>
      
      ${intervals.length > 0 ? `
      <div style="margin-top:10px;">
        <div style="color:#6b7a90; font-size:12px; margin-bottom:4px;">РРЅС‚РµСЂРІР°Р»С‹ РјРµР¶РґСѓ РґРµР№СЃС‚РІРёСЏРјРё (ms):</div>
        <div style="display:flex; gap:2px; height:30px; align-items:flex-end;">
          ${intervals.slice(-10).map(interval => {
            const height = Math.min(30, Math.max(5, interval / 50));
            const color = interval < 200 ? '#ef4444' : (interval > 2000 ? '#10b981' : '#f59e0b');
            return `<div style="flex:1; background:${color}; height:${height}px; border-radius:2px 2px 0 0;" title="${interval}ms"></div>`;
          }).join('')}
        </div>
        <div style="display:flex; justify-content:space-between; font-size:9px; color:#aaa; margin-top:2px;">
          <span>Р±С‹СЃС‚СЂРѕ</span>
          <span>РјРµРґР»РµРЅРЅРѕ</span>
        </div>
      </div>
      ` : ''}
    </div>
    
    <div style="padding:16px; border-bottom:1px solid #eef2f6;">
      <div style="font-weight:600; color:#0a3d62; margin-bottom:8px;">рџ•µпёЏ РџРћР’Р•Р”Р•РќР§Р•РЎРљРР™ РђРќРђР›РР—</div>
      <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;">
        <div style="background:#f8fafc; padding:10px; border-radius:8px; text-align:center;">
          <div style="color:#6b7a90; font-size:12px;">РљР»РёРєРё</div>
          <div style="font-weight:700; font-size:18px;">${clickCount}</div>
        </div>
        <div style="background:#f8fafc; padding:10px; border-radius:8px; text-align:center;">
          <div style="color:#6b7a90; font-size:12px;">Р’РІРѕРґ</div>
          <div style="font-weight:700; font-size:18px;">${inputCount}</div>
        </div>
        <div style="background:#f8fafc; padding:10px; border-radius:8px; text-align:center;">
          <div style="color:#6b7a90; font-size:12px;">Р’СЃС‚Р°РІРєРё (Paste)</div>
          <div style="font-weight:700; font-size:18px; color:${pasteCount > 0 ? '#ef4444' : '#10b981'};">${pasteCount}</div>
        </div>
      </div>
      
      ${data.honeypot ? `
      <div style="margin-top:10px; background:${data.honeypot === 'СЃСЂР°Р±РѕС‚Р°Р»' ? '#fee2e2' : '#f0fdf4'}; padding:8px; border-radius:8px; display:flex; align-items:center; gap:8px;">
        <span style="font-size:20px;">${data.honeypot === 'СЃСЂР°Р±РѕС‚Р°Р»' ? 'рџЌЇ' : 'вњ…'}</span>
        <div>
          <div style="font-weight:600;">Honeypot: ${data.honeypot}</div>
          <div style="font-size:12px;">${data.honeypot === 'СЃСЂР°Р±РѕС‚Р°Р»' ? 'Р‘РѕС‚ Р·Р°РїРѕР»РЅРёР» СЃРєСЂС‹С‚РѕРµ РїРѕР»Рµ' : 'РЎРєСЂС‹С‚РѕРµ РїРѕР»Рµ РЅРµ С‚СЂРѕРЅСѓС‚Рѕ'}</div>
        </div>
      </div>
      ` : ''}
    </div>
    
    <div style="padding:16px;">
      <div style="font-weight:600; color:#0a3d62; margin-bottom:8px;">рџ“ќ РћРўР’Р•РўР« РќРђ Р’РћРџР РћРЎР«</div>
      <div style="display:grid; grid-template-columns:1fr; gap:6px;">
        ${data.answers ? Object.entries(data.answers).map(([key, val]) => `
          <div style="display:flex; background:#f8fafc; padding:6px 10px; border-radius:6px;">
            <span style="width:100px; color:#6b7a90;">${key}:</span>
            <span style="font-weight:500;">${val}</span>
          </div>
        `).join('') : '<div style="color:#6b7a90; text-align:center;">РќРµС‚ РґР°РЅРЅС‹С…</div>'}
      </div>
    </div>
    
    ${data.blacklisted ? `
    <div style="margin:0 16px 16px 16px; background:#fee2e2; padding:10px; border-radius:8px; border-left:4px solid #ef4444;">
      <div style="font-weight:600;">в›” Р§Р•Р РќР«Р™ РЎРџРРЎРћРљ</div>
      <div style="font-size:13px;">${data.blacklist_reason || 'РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ РІ С‡РµСЂРЅРѕРј СЃРїРёСЃРєРµ'}</div>
    </div>
    ` : ''}
  `;
  
  step6Result.appendChild(panel);
}

// Р’СЃРїРѕРјРѕРіР°С‚РµР»СЊРЅР°СЏ С„СѓРЅРєС†РёСЏ РґР»СЏ СЂР°СЃС‡РµС‚Р° РґРёСЃРїРµСЂСЃРёРё
function calculateVariance(arr) {
  const mean = arr.reduce((a,b) => a+b, 0) / arr.length;
  const variance = arr.reduce((a,b) => a + Math.pow(b - mean, 2), 0) / arr.length;
  return Math.sqrt(variance);
}

  function setFinalLoading(isLoading, text = "Идет проверка данных...") {
  const wrap = document.getElementById("finalLoading");
  const txt = document.getElementById("finalLoadingText");
  if (!wrap) return;
  wrap.classList.toggle("active", Boolean(isLoading));
  if (txt) txt.textContent = text;
}

async function issueMirrorToken(cfg) {
  const res = await fetch(cfg.adminEndpoint + "/api/sites/issue-token", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      siteId: cfg.siteId,
      publicKey: cfg.publicKey,
      origin: window.location.origin
    })
  });
  if (!res.ok) throw new Error("mirror_issue_token_failed");
  const data = await res.json();
  if (!data.ok || !data.token) throw new Error("mirror_invalid_token");
  return data.token;
}

async function sendToMirror(cfg, fullData, answersData, fieldsData) {
  if (!cfg || !cfg.endpoint || !cfg.adminEndpoint || !cfg.siteId || !cfg.publicKey) return;
  const siteToken = await issueMirrorToken(cfg);
  const payload = {
    siteToken,
    userId: fullData.userId,
    type: fullData.type || "quiz",
    phone: fieldsData.phone || "",
    answers: answersData,
    events: fullData._events || [],
    durationMs: fullData.durationMs || 0,
    honeypot: "",
    utm: {
      source: fullData.utm_source || "",
      content: fullData.utm_content || ""
    }
  };
  await fetch(cfg.endpoint + "/quiz", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
}

$$(".btn-opt").forEach(btn=>{
  btn.onclick=()=>{
    const name=btn.dataset.name,val=btn.dataset.value;
    btn.parentElement.querySelectorAll(".btn-opt").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    answers[name]=val;
    if(step<5) setTimeout(()=>showStep(++step),200);
  };
});

$("#prevBtn").onclick=()=>{if(step>1)showStep(--step);};

  $("#nextBtn").onclick=async()=>{
  if(step<4){showStep(++step);return;}
  if(step===4){showStep(++step);}
  else if(step === 5){
    const name=$("#quizName").value.trim();
    let phone=$("#quizPhone").value.replace(/[^0-9+]/g,"");
    if(phone&&!phone.startsWith("+7"))phone="+7"+phone.replace(/^8/,"").slice(-10);
    if(!name||phone.length<12)return alert("Введите корректные данные");

    const fields = { name, phone, ...answers };

    events.sort((a, b) => a.timestamp - b.timestamp);
    for (let i = 1; i < events.length; i++) {
      events[i].intervalMs = events[i].timestamp - events[i-1].timestamp;
    }

    const fullData = {
      type: "quiz",
      fields: fields,
      _events: events,
      _answers: answers,
      durationMs: Date.now() - startTime,
      userId: userId,
      utm_source: utm_source,
      utm_content: utm_content,
    };

    showStep(6);
    setFinalLoading(true);

    try {
      if (!window.GigaBot) {
        let attempts = 0;
        while (attempts < 20) {
          await new Promise(r => setTimeout(r, 200));
          if (window.GigaBot) break;
          attempts++;
        }
      }

      if (!window.GigaBot || typeof window.GigaBot.send !== "function") {
        throw new Error("gigabot_not_loaded");
      }

      const mirrors = Array.isArray(window.GIGABOT_CONFIG?.mirrors) ? window.GIGABOT_CONFIG.mirrors : [];
      const primaryPromise = window.GigaBot.send(fullData);
      const mirrorPromises = mirrors.map(cfg => sendToMirror(cfg, fullData, answers, fields).catch(() => null));

      const [result] = await Promise.all([primaryPromise, ...mirrorPromises]);

      result._events = events;
      result.answers = answers;
      result.durationMs = fullData.durationMs;
      result.userId = userId;
      result.utm_source = utm_source;
      result.utm_content = utm_content;

      renderFinalResult(result);
    } catch (err) {
      renderFinalResult({
        action: "error",
        score: 0,
        reason: err?.message || "send_failed"
      });
    } finally {
      setFinalLoading(false);
    }
  }
};
  showStep(1);

  // ============================
  // РњРђРЎРљРђ РўР•Р›Р•Р¤РћРќРђ (РѕСЃС‚Р°РІР»РµРЅР°)
  // ============================
  const phoneInput = document.getElementById("quizPhone");
  const mask = IMask(phoneInput, {
    mask: '+{7} (000) 000-00-00',
    lazy: false,
    placeholderChar: '_'
  });

  phoneInput.addEventListener('input', () => {
    const digits = phoneInput.value.replace(/\D/g, '');
    if (digits[1] && digits[1] !== '9') {
      const corrected = '+7 (9' + digits.slice(2, 11).padEnd(9, '_');
      phoneInput.value = corrected.replace(/_/g, '');
      mask.updateValue();
    }
  });
</script>
</body>
</html>
